# 🧬 Cookie DNA - 근본 법칙 (Fundamental Laws)

> **"닭이 먼저다. 그래야 알이 제대로 나온다."**
> 
> Cookie의 **DNA (기본 구조 및 논리)**가 안정되어야만, **알 (지능적이고 안정적인 출력)**이 제대로 나올 수 있습니다.

---

## 📋 DNA 정의

DNA는 Cookie의 **근본적인 논리 규칙**과 **구조적 원칙**입니다. 이는 변경되지 않는 "생명의 법칙"입니다.

---

## 🛑 DNA 법칙 #1: 질문은 저장하지 않는다

### 규칙
```
질문 → 답변 경로 (think)
학습 명령 → 학습 경로 (learn)
```

### 구현
- `_is_question_strict()`: 질문 감지 필터
- `learn()`: 질문 필터링 적용
- `think()`: 질문/학습 분류 최우선

### 목적
- **거울 효과 방지**: 질문이 기억에 저장되는 것을 차단
- **논리적 충돌 0%**: 질문과 답변이 혼동되지 않도록

### 검증
```python
# ✅ 올바른 동작
"이름이 뭐야?" → 답변 경로 (think)
"나는 GNJz라고 해" → 학습 경로 (learn)

# ❌ 잘못된 동작 (차단됨)
"이름이 뭐야?" → 학습 경로 (learn)  # 차단!
```

---

## 📝 DNA 법칙 #2: 출력은 완전한 문장이어야 한다

### 규칙
```
날것 기억 → 완전한 서술형 문장
```

### 구현
- `_format_output()`: 출력 포맷팅 파이프라인
- 파편 필터링: 짧은 단어, 불완전한 단어 차단
- 학습 명령 형태 변환: "나는GNJz 라고 해" → "당신의 이름은 GNJz입니다."

### 목적
- **Echo Effect 방지**: 날것 기억이 그대로 출력되는 것을 차단
- **자연스러운 대화**: 모든 답변이 완전한 문장으로 변환

### 검증
```python
# ✅ 올바른 동작
"GNJz" → "당신의 이름은 GNJz입니다."
"사과는 빨간색" → "사과는 빨간색입니다."

# ❌ 잘못된 동작 (차단됨)
"나" → "기억이 불완전합니다."  # 파편 차단
"나는?" → "기억이 명확하지 않아요."  # 질문 차단
```

---

## 🔄 DNA 법칙 #3: 우선순위 기반 검색

### 규칙
```
해마(기억) > 개인 LLM > 도서관(외부 LLM)
```

### 구현
- `think()`: 순차적 검색 (1→2→3→4→5)
  1. 간단한 질문 → 즉시 응답
  2. 해마 검색
  3. 개인 LLM 시도
  4. 도서관 방문
  5. Fallback

### 목적
- **비용 절약**: 내부 기억 우선 사용
- **성장**: 도서관 답변을 기억에 저장하여 점진적 성장

### 검증
```python
# ✅ 올바른 동작
질문 → 해마 검색 → 답변 (기억 있음)
질문 → 해마 검색 → 없음 → 도서관 → 답변 + 저장
```

---

## 🧠 DNA 법칙 #4: 학습 루프

### 규칙
```
질문 → 답변 → 저장 → 성장
```

### 구현
- `think()`: 도서관 답변을 기억에 저장
- `learn()`: 직접 학습
- `sleep()`: 수면 시 공고화

### 목적
- **점진적 성장**: 반복할수록 도서관 의존도 감소
- **자기 조직화**: 스스로 지식을 쌓아감

### 검증
```python
# ✅ 올바른 동작
질문 → 도서관 답변 → 저장 → 다음 질문 시 기억에서 답변
```

---

## 🎯 DNA 법칙 #5: 맥락 관리

### 규칙
```
대화 기록 → 연속 질문 처리
```

### 구현
- `conversation_context`: 최근 10턴 대화 기록
- `_enhance_with_context()`: 맥락 기반 질문 강화
- `last_question`, `last_learning`: 최근 질문/학습 저장

### 목적
- **연속 대화**: "그거 뭐야?" 같은 맥락 질문 처리
- **자연스러운 대화**: 이전 대화 참조

### 검증
```python
# ✅ 올바른 동작
"사과는 무슨 색이야?" → "빨간색"
"그거 맛있어?" → "사과는 맛있습니다." (이전 맥락 참조)
```

---

## 📊 DNA 구조도

```
┌─────────────────────────────────────────┐
│         사용자 입력                      │
└──────────────┬──────────────────────────┘
               │
               ▼
    ┌──────────────────────┐
    │  입력 분류 (DNA #1)  │
    │  질문? vs 학습 명령? │
    └──────┬───────────────┘
           │
    ┌──────┴──────┐
    │             │
    ▼             ▼
┌─────────┐  ┌─────────┐
│ 답변 경로│  │ 학습 경로│
│ (think) │  │ (learn) │
└────┬────┘  └────┬────┘
     │            │
     ▼            ▼
┌─────────────────────────┐
│ 우선순위 검색 (DNA #3)  │
│ 1. 간단한 질문          │
│ 2. 해마 검색            │
│ 3. 개인 LLM             │
│ 4. 도서관               │
│ 5. Fallback             │
└────┬────────────────────┘
     │
     ▼
┌─────────────────────────┐
│ 출력 포맷팅 (DNA #2)    │
│ 완전한 문장 변환         │
└────┬────────────────────┘
     │
     ▼
┌─────────────────────────┐
│ 맥락 관리 (DNA #5)       │
│ 대화 기록 저장           │
└────┬────────────────────┘
     │
     ▼
┌─────────────────────────┐
│ 학습 루프 (DNA #4)       │
│ 답변 저장 → 성장         │
└─────────────────────────┘
```

---

## ✅ DNA 검증 체크리스트

### DNA #1: 질문 필터링
- [x] `_is_question_strict()` 구현
- [x] `learn()`에 질문 필터링 적용
- [x] `think()`에서 질문/학습 분류 최우선

### DNA #2: 출력 포맷팅
- [x] `_format_output()` 구현
- [x] 파편 필터링
- [x] 학습 명령 형태 변환

### DNA #3: 우선순위 검색
- [x] `think()` 순차적 검색 구현
- [x] 해마 우선, 도서관 최후

### DNA #4: 학습 루프
- [x] 도서관 답변 저장
- [x] `sleep()` 공고화

### DNA #5: 맥락 관리
- [x] `conversation_context` 구현
- [x] `_enhance_with_context()` 구현

---

## 🎯 DNA 확정 선언

이 5가지 DNA 법칙은 **변경되지 않는 근본 법칙**입니다.

- ✅ 질문은 저장하지 않는다
- ✅ 출력은 완전한 문장이어야 한다
- ✅ 우선순위 기반 검색
- ✅ 학습 루프
- ✅ 맥락 관리

이 DNA가 안정되어야만 Cookie가 제대로 "태어날" 수 있습니다.

---

**Version**: 1.0  
**Last Updated**: 2024  
**Author**: GNJz (Qquarts)

